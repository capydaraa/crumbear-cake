{% extends "admin_base.html" %}

{% block title %}Manage Designs - Admin{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row mb-4">
        <div class="col-md-8">
            <h1 class="mb-2"><i class="bi bi-palette"></i> Manage Cake Designs</h1>
            <p class="text-muted">Add, edit, or remove visual designs for cakes</p>
        </div>
        <div class="col-md-4 text-end">
            <button class="btn btn-lg" style="background-color: #AC4037; color: white;" data-bs-toggle="modal" data-bs-target="#addDesignModal">
                <i class="bi bi-plus-circle"></i> Add New Design
            </button>
        </div>
    </div>

    <!-- Search and Filter Section -->
    <div class="card shadow-sm mb-4">
        <div class="card-body">
            <div class="row g-3 align-items-center">
                <div class="col-md-4">
                    <div class="input-group">
                        <span class="input-group-text"><i class="bi bi-search"></i></span>
                        <input type="text" class="form-control" id="searchInput" placeholder="Search designs...">
                    </div>
                </div>
                <div class="col-md-3">
                    <select class="form-select" id="complexityFilter">
                        <option value="">All Complexity</option>
                        <option value="Simple">Simple</option>
                        <option value="Moderate">Moderate</option>
                        <option value="Complex">Complex</option>
                        <option value="Expert">Expert</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <select class="form-select" id="sortOrder">
                        <option value="id">Sort by ID</option>
                        <option value="theme">Sort by Theme</option>
                        <option value="price-asc">Price: Low-High</option>
                        <option value="price-desc">Price: High-Low</option>
                        <option value="rating-desc">Highest Rated</option>
                    </select>
                </div>
                <div class="col-md-2 text-end">
                    <span class="badge bg-secondary" style="font-size: 0.9rem;"><span id="designCount">{{ designs|length }}</span> designs</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Designs Grid -->
    <div class="row" id="designsGrid">
        {% for design in designs %}
        <div class="col-md-4 col-lg-3 mb-4 design-card" data-theme="{{ design.theme|lower }}" data-cake="{{ design.cake_name|lower }}" data-complexity="{{ design.complexity_level }}" data-price="{{ design.calculated_price }}" data-rating="{{ design.avg_rating }}" data-featured="{{ design.featured }}">
            <div class="card h-100 shadow-sm{% if design.featured %} border-warning{% endif %}">
                <div class="position-relative">
                    <img src="{{ design.image_url }}" class="card-img-top" alt="{{ design.theme }}" style="height: 200px; object-fit: cover;">
                    {% if design.featured %}
                    <span class="position-absolute top-0 end-0 m-2 badge bg-warning text-dark">
                        <i class="bi bi-star-fill"></i> Featured
                    </span>
                    {% endif %}
                </div>
                <div class="card-body">
                    <h5 class="card-title">{{ design.theme }}</h5>
                    <p class="card-text mb-1">
                        <small class="text-muted">Cake:</small> <strong>{{ design.cake_name }}</strong>
                    </p>
                    <p class="card-text mb-1">
                        <span class="badge" style="background-color: #EDCAD4; color: #333;">{{ design.color_palette }}</span>
                        <span class="badge" style="background-color: #BF6865;">{{ design.complexity_level }}</span>
                    </p>
                    <p class="card-text mb-2">
                        {% if design.topper_type %}
                        <small><i class="bi bi-star-fill text-warning"></i> {{ design.topper_type }}</small>
                        {% endif %}
                    </p>
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <span class="text-warning">
                                {% for i in range(5) %}
                                    {% if i < design.avg_rating|int %}
                                    <i class="bi bi-star-fill"></i>
                                    {% else %}
                                    <i class="bi bi-star"></i>
                                    {% endif %}
                                {% endfor %}
                            </span>
                            <small class="text-muted">({{ design.review_count }})</small>
                        </div>
                        <strong style="color: #AC4037;">â‚±{{ "%.2f"|format(design.calculated_price) }}</strong>
                    </div>
                </div>
                <div class="card-footer bg-transparent text-nowrap">
                    <button class="btn btn-sm text-primary p-1" style="border: none; background: none;" onclick="editDesign({{ design.design_id }})" title="Edit">
                        <i class="bi bi-pencil"></i> Edit
                    </button>
                    <button class="btn btn-sm text-danger p-1" style="border: none; background: none;" onclick="confirmDelete({{ design.design_id }}, '{{ design.theme }}')" title="Delete">
                        <i class="bi bi-trash"></i> Delete
                    </button>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Add Design Modal -->
<div class="modal fade" id="addDesignModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header" style="background-color: #EDCAD4;">
                <h5 class="modal-title"><i class="bi bi-plus-circle"></i> Add New Design</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form action="{{ url_for('admin_add_design') }}" method="POST" enctype="multipart/form-data" onsubmit="return validateForm(this)">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Base Cake *</label>
                            <select class="form-select" name="cake_id" required>
                                <option value="">Select a cake...</option>
                                {% for cake in cakes %}
                                <option value="{{ cake.cake_id }}">{{ cake.cake_name }} ({{ cake.flavor }})</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Theme *</label>
                            <input type="text" class="form-control" name="theme" required placeholder="e.g., Birthday Party, Wedding Elegant">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Color Palette *</label>
                            <select class="form-select" name="color_palette" required>
                                <option value="">Select colors...</option>
                                <option value="Pink & White">Pink & White</option>
                                <option value="Blue & Silver">Blue & Silver</option>
                                <option value="Gold & Ivory">Gold & Ivory</option>
                                <option value="Black & White">Black & White</option>
                                <option value="Pastel Rainbow">Pastel Rainbow</option>
                                <option value="Green & Brown">Green & Brown</option>
                                <option value="Yellow & White">Yellow & White</option>
                                <option value="Red & Gold">Red & Gold</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Complexity Level *</label>
                            <select class="form-select" name="complexity_level" required>
                                <option value="">Select complexity...</option>
                                <option value="Simple">Simple (1x base price)</option>
                                <option value="Moderate">Moderate (1.25x base price)</option>
                                <option value="Complex">Complex (1.5x base price)</option>
                                <option value="Expert">Expert (2x base price)</option>
                            </select>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Topper Type</label>
                            <select class="form-select" name="topper_type">
                                <option value="">None</option>
                                <option value="Candles">Candles</option>
                                <option value="Fresh Flowers">Fresh Flowers</option>
                                <option value="Fondant Figures">Fondant Figures</option>
                                <option value="Cake Topper Sign">Cake Topper Sign</option>
                                <option value="Chocolate Decorations">Chocolate Decorations</option>
                                <option value="Berries">Berries</option>
                                <option value="Custom Figurine">Custom Figurine</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Design Image</label>
                            <input type="file" class="form-control" name="image" accept="image/*">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" name="featured" id="addFeatured" style="width: 3em; height: 1.5em;">
                                <label class="form-check-label ms-2" for="addFeatured">
                                    <i class="bi bi-star-fill text-warning"></i> <strong>Featured</strong>
                                    <small class="text-muted d-block">Show at top of catalog page 1</small>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn" style="background-color: #AC4037; color: white;">Add Design</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Design Modal -->
<div class="modal fade" id="editDesignModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header" style="background-color: #EDCAD4;">
                <h5 class="modal-title"><i class="bi bi-pencil"></i> Edit Design</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="editDesignForm" method="POST" enctype="multipart/form-data" onsubmit="return validateForm(this)">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Base Cake *</label>
                            <select class="form-select" name="cake_id" id="editCakeId" required>
                                {% for cake in cakes %}
                                <option value="{{ cake.cake_id }}">{{ cake.cake_name }} ({{ cake.flavor }})</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Theme *</label>
                            <input type="text" class="form-control" name="theme" id="editTheme" required>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Color Palette *</label>
                            <select class="form-select" name="color_palette" id="editColorPalette" required>
                                <option value="Pink & White">Pink & White</option>
                                <option value="Blue & Silver">Blue & Silver</option>
                                <option value="Gold & Ivory">Gold & Ivory</option>
                                <option value="Black & White">Black & White</option>
                                <option value="Pastel Rainbow">Pastel Rainbow</option>
                                <option value="Green & Brown">Green & Brown</option>
                                <option value="Yellow & White">Yellow & White</option>
                                <option value="Red & Gold">Red & Gold</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Complexity Level *</label>
                            <select class="form-select" name="complexity_level" id="editComplexityLevel" required>
                                <option value="Simple">Simple</option>
                                <option value="Moderate">Moderate</option>
                                <option value="Complex">Complex</option>
                                <option value="Expert">Expert</option>
                            </select>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Topper Type</label>
                            <select class="form-select" name="topper_type" id="editTopperType">
                                <option value="">None</option>
                                <option value="Candles">Candles</option>
                                <option value="Fresh Flowers">Fresh Flowers</option>
                                <option value="Fondant Figures">Fondant Figures</option>
                                <option value="Cake Topper Sign">Cake Topper Sign</option>
                                <option value="Chocolate Decorations">Chocolate Decorations</option>
                                <option value="Berries">Berries</option>
                                <option value="Custom Figurine">Custom Figurine</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">New Image (optional)</label>
                            <input type="file" class="form-control" name="image" accept="image/*">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" name="featured" id="editFeatured" style="width: 3em; height: 1.5em;">
                                <label class="form-check-label ms-2" for="editFeatured">
                                    <i class="bi bi-star-fill text-warning"></i> <strong>Featured</strong>
                                    <small class="text-muted d-block">Show at top of catalog page 1</small>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn" style="background-color: #AC4037; color: white;">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title"><i class="bi bi-exclamation-triangle"></i> Confirm Delete</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete design <strong id="deleteItemName"></strong>?</p>
                <p class="text-muted small">This cannot be undone.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Delete</button>
            </div>
        </div>
    </div>
</div>

<script>
const designsData = {{ designs|tojson|safe }};

function editDesign(designId) {
    const design = designsData.find(d => d.design_id === designId);
    if (design) {
        document.getElementById('editCakeId').value = design.cake_id;
        document.getElementById('editTheme').value = design.theme;
        document.getElementById('editColorPalette').value = design.color_palette;
        document.getElementById('editComplexityLevel').value = design.complexity_level;
        document.getElementById('editTopperType').value = design.topper_type || '';
        document.getElementById('editFeatured').checked = design.featured ? true : false;
        document.getElementById('editDesignForm').action = `/admin/designs/edit/${designId}`;
        new bootstrap.Modal(document.getElementById('editDesignModal')).show();
    }
}

let deleteId = null;
function confirmDelete(id, name) {
    deleteId = id;
    document.getElementById('deleteItemName').textContent = name;
    new bootstrap.Modal(document.getElementById('deleteModal')).show();
}

document.addEventListener('DOMContentLoaded', function() {
    const confirmBtn = document.getElementById('confirmDeleteBtn');
    if (confirmBtn) {
        confirmBtn.addEventListener('click', function() {
            if (deleteId) {
                fetch(`/admin/designs/delete/${deleteId}`, { 
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                })
                .then(res => res.json())
                .then(data => {
                    bootstrap.Modal.getInstance(document.getElementById('deleteModal')).hide();
                    if (data.success) {
                        showToast('Design deleted successfully!', 'success');
                        setTimeout(() => location.reload(), 1000);
                    } else {
                        showToast(data.message || 'Failed to delete', 'error');
                    }
                })
                .catch(err => {
                    bootstrap.Modal.getInstance(document.getElementById('deleteModal')).hide();
                    showToast('Error deleting design: ' + err.message, 'error');
                });
            }
        });
    }
});

const urlParams = new URLSearchParams(window.location.search);
if (urlParams.get('success')) showToast(urlParams.get('success'), 'success');
if (urlParams.get('error')) showToast(urlParams.get('error'), 'error');

// Search and Filter Functionality
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('searchInput');
    const complexityFilter = document.getElementById('complexityFilter');
    const sortOrder = document.getElementById('sortOrder');
    const designsGrid = document.getElementById('designsGrid');
    const designCount = document.getElementById('designCount');
    
    if (!searchInput || !complexityFilter || !sortOrder || !designsGrid || !designCount) {
        console.error('Search/filter elements not found');
        return;
    }
    
    function filterAndSort() {
        const searchTerm = searchInput.value.toLowerCase().trim();
        const complexity = complexityFilter.value;
        const sort = sortOrder.value;
        
        const cards = Array.from(designsGrid.querySelectorAll('.design-card'));
        let visibleCount = 0;
        
        cards.forEach(card => {
            const theme = (card.dataset.theme || '').toLowerCase();
            const cake = (card.dataset.cake || '').toLowerCase();
            const cardComplexity = card.dataset.complexity || '';
            
            const matchesSearch = searchTerm === '' || theme.includes(searchTerm) || cake.includes(searchTerm);
            const matchesComplexity = !complexity || cardComplexity === complexity;
            
            if (matchesSearch && matchesComplexity) {
                card.classList.remove('d-none');
                visibleCount++;
            } else {
                card.classList.add('d-none');
            }
        });
        
        // Sort visible cards
        const visibleCards = cards.filter(c => !c.classList.contains('d-none'));
        visibleCards.sort((a, b) => {
            if (sort === 'theme') return (a.dataset.theme || '').localeCompare(b.dataset.theme || '');
            if (sort === 'price-asc') return parseFloat(a.dataset.price || 0) - parseFloat(b.dataset.price || 0);
            if (sort === 'price-desc') return parseFloat(b.dataset.price || 0) - parseFloat(a.dataset.price || 0);
            if (sort === 'rating-desc') return parseFloat(b.dataset.rating || 0) - parseFloat(a.dataset.rating || 0);
            return 0;
        });
        visibleCards.forEach(card => designsGrid.appendChild(card));
        
        designCount.textContent = visibleCount;
    }
    
    searchInput.addEventListener('input', filterAndSort);
    complexityFilter.addEventListener('change', filterAndSort);
    sortOrder.addEventListener('change', filterAndSort);
    
    // Initial filter
    filterAndSort();
});
</script>
{% endblock %}

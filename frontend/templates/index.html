{% extends "base.html" %}

{% block title %}Browse Cake Designs - Crumbear{% endblock %}

{% block content %}
<div class="container">
    <!-- User Greeting Bar (above search) -->
    {% if logged_in_customer %}
    <div class="d-flex justify-content-between align-items-center mb-3 px-2">
        <span style="color: #AC4037; font-weight: 500; font-size: 1.1rem;">
            üëã Hi, {{ logged_in_customer.full_name }}!
        </span>
        <button onclick="confirmUserLogout()" class="btn btn-sm" style="background-color: #AC4037; color: white; border-radius: 20px; padding: 6px 20px;">
            Sign Out
        </button>
    </div>
    {% endif %}
    
    <!-- Search Bar -->
    <div class="search-section mb-4">
        <div class="input-group" style="border-radius: 25px; overflow: hidden; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
            <span class="input-group-text" style="background-color: var(--soft-pink); border: none; padding-left: 20px;">
                üîç
            </span>
            <input type="text" class="form-control" id="searchInput" 
                   placeholder="Search by theme, cake name, or flavor..." 
                   style="border: none; padding: 15px;">
            <button class="btn" type="button" id="clearSearch" 
                    style="background-color: var(--primary-pink); color: white; border: none; padding: 0 25px;">
                Clear
            </button>
        </div>
    </div>
    
    <!-- Theme Filters and Sorting -->
    <div class="filter-section mb-4">
        <div class="d-flex flex-wrap justify-content-between align-items-center">
            <!-- Category Filters (left) -->
            <div class="category-filter d-flex flex-wrap gap-2">
                <button class="category-btn active" data-theme="all">All</button>
                <button class="category-btn" data-theme="Birthday">Birthday</button>
                <button class="category-btn" data-theme="Wedding">Wedding</button>
                <button class="category-btn" data-theme="Anniversary">Anniversary</button>
                <button class="category-btn" data-theme="Graduation">Graduation</button>
                <button class="category-btn" data-theme="Holiday">Holiday</button>
            </div>
            
            <!-- Sorting Filters (right) -->
            <div class="sorting-filters d-flex gap-2 align-items-center mt-2 mt-md-0" style="margin-left: 10px;">
                <!-- Price Sort Toggle Button -->
                <button class="btn sort-btn" id="priceSortBtn" data-sort="none" 
                        style="background-color: #EDCAD4; color: #AC4037; border: 2px solid #AC4037; border-radius: 20px; padding: 8px 16px; font-weight: 500;">
                    üí∞ Price
                </button>
                
                <!-- Star Rating Filter Dropdown -->
                <div class="dropdown">
                    <button class="btn dropdown-toggle" type="button" id="ratingFilterBtn" data-bs-toggle="dropdown" aria-expanded="false"
                            style="background-color: #EDCAD4; color: #AC4037; border: 2px solid #AC4037; border-radius: 20px; padding: 8px 16px; font-weight: 500;">
                        ‚≠ê Rating
                    </button>
                    <ul class="dropdown-menu" aria-labelledby="ratingFilterBtn" style="border-radius: 15px; border: 2px solid #EDCAD4;">
                        <li><a class="dropdown-item rating-filter active" href="#" data-rating="all">All Ratings</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item rating-filter" href="#" data-rating="5">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê 5 Stars</a></li>
                        <li><a class="dropdown-item rating-filter" href="#" data-rating="4">‚≠ê‚≠ê‚≠ê‚≠ê 4+ Stars</a></li>
                        <li><a class="dropdown-item rating-filter" href="#" data-rating="3">‚≠ê‚≠ê‚≠ê 3+ Stars</a></li>
                        <li><a class="dropdown-item rating-filter" href="#" data-rating="2">‚≠ê‚≠ê 2+ Stars</a></li>
                        <li><a class="dropdown-item rating-filter" href="#" data-rating="1">‚≠ê 1+ Stars</a></li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Call to Action -->
    <div class="content-section text-center mb-5">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h3>üí≠ Want a custom cake?</h3>
                <p class="mb-0">Calculate your custom cake price with our interactive price calculator! Choose size, complexity, and more. üç∞‚ú®</p>
            </div>
            <div class="col-md-4">
                <a href="{{ url_for('calculator') }}" class="btn btn-primary btn-lg">
                    Calculate Price ‚Üí
                </a>
            </div>
        </div>
    </div>

    <!-- Designs Grid -->
    <div class="row" id="designsGrid">
        {% if designs %}
            {% for design in designs %}
            <div class="col-lg-3 col-md-4 col-sm-6 design-item mb-4" 
                 data-theme="{{ design.theme }}"
                 data-cake-name="{{ design.cake_name }}"
                 data-flavor="{{ design.flavor }}"
                 data-design-id="{{ design.design_id }}"
                 data-price="{{ design.calculated_price }}"
                 data-rating="{{ design.avg_rating }}">
                <a href="{{ url_for('design_detail', design_id=design.design_id) }}" class="text-decoration-none">
                    <div class="cake-card" style="cursor: pointer; transition: transform 0.3s, box-shadow 0.3s;">
                        <div class="position-relative" style="border-radius: 20px; overflow: hidden; border: 2px solid #EDCAD4;">
                            <img src="{{ design.image_url or url_for('static', filename='images/placeholder-cake.jpg') }}" 
                                 alt="{{ design.theme }}" 
                                 loading="lazy"
                                 style="height: 200px; object-fit: cover; width: 100%;">
                            <!-- Rating Badge -->
                            {% if design.review_count > 0 %}
                            <span class="position-absolute top-0 end-0 m-2 badge" 
                                  style="background-color: rgba(172, 64, 55, 0.9); border-radius: 10px;">
                                ‚≠ê {{ "%.1f"|format(design.avg_rating) }}
                            </span>
                            {% endif %}
                        </div>
                        <!-- Price -->
                        <div style="margin-top: 5px;">
                            <div class="price-display" style="font-size: 1.3rem; color: #AC4037; font-weight: bold;">
                                ‚Ç±{{ "%.2f"|format(design.calculated_price) }}
                            </div>
                        </div>
                    </div>
                </a>
            </div>
            {% endfor %}
        {% else %}
            <div class="col-12">
                <div class="content-section text-center">
                    <h3>üöß Under Crumbstruction!</h3>
                    <p>No designs available yet. Check back soon! üß∏ü™Ñ‚ú®</p>
                </div>
            </div>
        {% endif %}
    </div>
    
    <!-- Pagination Controls -->
    {% if total_pages > 1 %}
    <nav aria-label="Cake designs pagination" class="mt-4">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <span style="color: #AC4037;">
                Showing {{ (page - 1) * 30 + 1 }}-{{ [page * 30, total_designs]|min }} of {{ total_designs }} designs
            </span>
        </div>
        <ul class="pagination justify-content-center" style="gap: 5px;">
            <!-- First Page -->
            {% if page > 1 %}
            <li class="page-item">
                <a class="page-link" href="{{ url_for('index', page=1) }}" style="border-radius: 10px; border: 2px solid #EDCAD4; color: #AC4037;">
                    ¬´ First
                </a>
            </li>
            <li class="page-item">
                <a class="page-link" href="{{ url_for('index', page=page-1) }}" style="border-radius: 10px; border: 2px solid #EDCAD4; color: #AC4037;">
                    ‚Äπ Prev
                </a>
            </li>
            {% endif %}
            
            <!-- Page Numbers -->
            {% set start_page = [1, page - 2]|max %}
            {% set end_page = [total_pages, page + 2]|min %}
            
            {% for p in range(start_page, end_page + 1) %}
            <li class="page-item {% if p == page %}active{% endif %}">
                <a class="page-link" href="{{ url_for('index', page=p) }}" 
                   style="border-radius: 10px; {% if p == page %}background-color: #AC4037; border-color: #AC4037; color: white;{% else %}border: 2px solid #EDCAD4; color: #AC4037;{% endif %}">
                    {{ p }}
                </a>
            </li>
            {% endfor %}
            
            <!-- Next/Last Page -->
            {% if page < total_pages %}
            <li class="page-item">
                <a class="page-link" href="{{ url_for('index', page=page+1) }}" style="border-radius: 10px; border: 2px solid #EDCAD4; color: #AC4037;">
                    Next ‚Ä∫
                </a>
            </li>
            <li class="page-item">
                <a class="page-link" href="{{ url_for('index', page=total_pages) }}" style="border-radius: 10px; border: 2px solid #EDCAD4; color: #AC4037;">
                    Last ¬ª
                </a>
            </li>
            {% endif %}
        </ul>
    </nav>
    {% endif %}
</div>

<style>
.cake-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 30px rgba(172, 64, 55, 0.2);
}
.sort-btn:hover, .sort-btn.active {
    background-color: #AC4037 !important;
    color: white !important;
}
.dropdown-item.rating-filter:hover, .dropdown-item.rating-filter.active {
    background-color: #EDCAD4;
    color: #AC4037;
}
.dropdown-item.rating-filter.active {
    font-weight: 600;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
// State variables
let currentPriceSort = 'none'; // 'none', 'low', 'high'
let currentRatingFilter = 'all';

// Theme filter functionality
document.querySelectorAll('.category-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        document.querySelectorAll('.category-btn').forEach(b => b.classList.remove('active'));
        this.classList.add('active');
        filterAndSortDesigns();
    });
});

// Price sort toggle button
const priceSortBtn = document.getElementById('priceSortBtn');
priceSortBtn.addEventListener('click', function() {
    if (currentPriceSort === 'none' || currentPriceSort === 'high') {
        currentPriceSort = 'low';
        this.innerHTML = 'üí∞ Price ‚Üë';
        this.classList.add('active');
    } else {
        currentPriceSort = 'high';
        this.innerHTML = 'üí∞ Price ‚Üì';
        this.classList.add('active');
    }
    filterAndSortDesigns();
});

// Rating filter dropdown
document.querySelectorAll('.rating-filter').forEach(item => {
    item.addEventListener('click', function(e) {
        e.preventDefault();
        document.querySelectorAll('.rating-filter').forEach(i => i.classList.remove('active'));
        this.classList.add('active');
        currentRatingFilter = this.dataset.rating;
        
        // Update button text
        const btn = document.getElementById('ratingFilterBtn');
        if (currentRatingFilter === 'all') {
            btn.innerHTML = '‚≠ê Rating';
        } else {
            btn.innerHTML = '‚≠ê ' + currentRatingFilter + '+ Stars';
        }
        
        filterAndSortDesigns();
    });
});

function filterAndSortDesigns() {
    const selectedTheme = document.querySelector('.category-btn.active').dataset.theme;
    const searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();
    
    const designItems = Array.from(document.querySelectorAll('.design-item'));
    const grid = document.getElementById('designsGrid');
    
    // Filter items
    designItems.forEach(item => {
        const theme = item.dataset.theme;
        const cakeName = item.dataset.cakeName.toLowerCase();
        const flavor = item.dataset.flavor.toLowerCase();
        const rating = parseFloat(item.dataset.rating) || 0;
        
        const matchesTheme = selectedTheme === 'all' || theme.includes(selectedTheme);
        const matchesSearch = searchTerm === '' || 
                             theme.toLowerCase().includes(searchTerm) || 
                             cakeName.includes(searchTerm) || 
                             flavor.includes(searchTerm);
        const matchesRating = currentRatingFilter === 'all' || rating >= parseFloat(currentRatingFilter);
        
        if (matchesTheme && matchesSearch && matchesRating) {
            item.style.display = 'block';
            item.style.opacity = '1';
            item.dataset.visible = 'true';
        } else {
            item.style.display = 'none';
            item.style.opacity = '0';
            item.dataset.visible = 'false';
        }
    });
    
    // Sort visible items by price if sorting is active
    if (currentPriceSort !== 'none') {
        const visibleItems = designItems.filter(item => item.dataset.visible === 'true');
        
        visibleItems.sort((a, b) => {
            const priceA = parseFloat(a.dataset.price);
            const priceB = parseFloat(b.dataset.price);
            return currentPriceSort === 'low' ? priceA - priceB : priceB - priceA;
        });
        
        // Reorder in DOM
        visibleItems.forEach(item => grid.appendChild(item));
    }
}

// Search functionality
const searchInput = document.getElementById('searchInput');
const clearSearchBtn = document.getElementById('clearSearch');

searchInput.addEventListener('input', filterAndSortDesigns);

clearSearchBtn.addEventListener('click', function() {
    searchInput.value = '';
    filterAndSortDesigns();
});
</script>
{% endblock %}
